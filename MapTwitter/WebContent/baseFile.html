<!DOCTYPE html>

<html>
<head>
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAiVv0FbzGUaLboe9ztIWi5CDPpg9PkZ50&sensor=false">
</script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.0.22.min.js"></script>

<script>
function initialize()
{

  var mapProp = {
  center:new google.maps.LatLng(40.520538, -101.208683),
  zoom:4,
  mapTypeId:google.maps.MapTypeId.ROADMAP
  };
var map=new google.maps.Map(document.getElementById("googleMap")
  ,mapProp);
  
AWS.config.update({accessKeyId: 'AKIAJFCL2EA4YBEHOIIQ', secretAccessKey: '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'});
AWS.config.region = 'us-east-1';
var db = new AWS.DynamoDB();

db.listTables( function (err, data) {
	
	if (err){
		alert(err);
	}
	else {
  		console.log(data.TableNames);
  	
	}
});

lastEvalKey = 0;

if (document.cookie.indexOf("lastEval") >= 0) {
	
	var myCookie = document.cookie.replace(/(?:(?:^|.*;\s*)lastEval\s*\=\s*([^;]*).*$)|^.*$/, "$1");	
	console.log("Existing Cookie: " + myCookie);
	lastEvalKey = myCookie;
	}
else {
	
	var params_new = {
			  TableName: 'twittMapNew', 
			  AttributesToGet: ['tweetID', 'latitude', 'longitude'],
			  Limit: 1
	}

	db.scan(params_new, function(err, data) {
		document.cookie = "lastEval" + data.LastEvaluatedKey.tweetID.S;
		console.log("new cookie: " + document.cookie);
	});
	
	var myCookie = document.cookie.replace(/(?:(?:^|.*;\s*)lastEval\s*\=\s*([^;]*).*$)|^.*$/, "$1");	
	console.log("Got New Cookie: " + myCookie);
	lastEvalKey = myCookie;

}

console.log("Last Key: "+lastEvalKey);

var randomnumber=Math.floor(Math.random()*151);	
	
var params = {
			  TableName: 'twittMapNew', 
			  AttributesToGet: ['tweetID', 'latitude', 'longitude', 'keyword'],
			  Limit: randomnumber,
			  //Exclusive Start Key - Wasn't able to set this from the cookie.
	}
	

markers = [];
coords = [];
labels = [];
iterator = 0;
iterator_coords = 0;

	db.scan(params, function(err, data) {
	  
	if (err) 
		  console.log(err); 
	else
		  console.log("last count: " + data.Count);
		
		console.log("LastEvaluatedKey: " + data.LastEvaluatedKey.tweetID.S);
		document.cookie = "lastEval" + data.LastEvaluatedKey.tweetID.S;
	  
		for (var ii in data.Items) {
			var curTweet = data.Items[ii];
			var temp_latLng= new google.maps.LatLng(parseFloat(curTweet.latitude.S), parseFloat(curTweet.longitude.S));
			var temp_label = curTweet.keyword.S
			coords.push(temp_latLng);
			labels.push(temp_label);
			console.log("Coordinate" + coords[iterator_coords]);
			iterator_coords++;
		}
	  console.log("Coords length: " + coords.length);
	  
	  var i = 0;
	  
	  for(i=0;i<coords.length;i++ ) {
	  markers.push(new google.maps.Marker({
		    position: coords[iterator],
		    map: map,
		    draggable: false,
		    title: labels[iterator]
		}));
		  iterator++;
	  }	  
	  
	  
	});
	
		
}

//google.maps.event.addDomListener(window, 'load', initialize({'refreshCount':1}));
google.maps.event.addDomListener(window, 'load', initialize);
</script>

</head>

<body>
<div id="googleMap" style="width:1280px;height:720px;"></div>

</body>
</html>
<!-- !DOCTYPE html> -->

<html>
<head>
<meta charset="UTF-8">
<title>TwittMap</title>
<script type="text/javascript">
window.setTimeout(function(){ document.location.reload(true); }, 15000);
</script>
</head>
<body>

</body>
</html>